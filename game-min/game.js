/*! Boxcar Racer - v - 2014-09-12
* Copyright (c) 2014 ; Licensed  */
Element.prototype.on=Element.prototype.addEventListener,Element.prototype.off=Element.prototype.removeEventListener,Element.prototype.index=function(a){for(var b=0;b<this.children.length;b++)if(a==this.children[b])return b},EventTarget.prototype.trigger=EventTarget.prototype.dispatchEvent,window.$=function(a){return document.querySelector(a)},window.toInt=window.parseInt,window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame,window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.oCancelAnimationFrame,window.Matrix=window.WebKitCSSMatrix||window.MSCSSMatrix||window.CSSMatrix,window.PI=Math.PI,window.audioCtx=new(window.AudioContext||window.webkitAudioContext),window.body=document.body;var game=function(){function a(){I=!0,y=new h,z=new g("car-shadow",y,{padding:3}),A=new j(L[0]),B=new i(y),$(".title-view").classList.add("animated","bounceInDown"),A.add(y,"children"),A.add(z,"children"),F.el.appendChild(A.el),c(),body.on("hit-cone",function(){K++,$(".combo-meter-fill").style.width=K+"%",s("cone_hit",K)});for(var a,d,e=0;e<L.length;e++)a=L[e],d=document.createElement("button"),d.innerText=a.name,d.style.backgroundImage=t(a.topColor,a.botColor),$(".levels").appendChild(d);$(".levels").on("click",function(a){for(var b=a.currentTarget.index(a.target),c=0;c<a.currentTarget.children.length;c++)a.currentTarget.children[c].classList.remove("active");a.target.classList.add("active"),game.show("gameplay",b)}),window.onresize=b,window.player=y,window.playerShadow=z,window.level=A,window.camera=F}function b(){clearTimeout(C),C=setTimeout(function(){c()},300)}function c(){F.render(),y.pos.y=A.height-200,A.offsetZ=.36*-D.clientHeight,A.pos.y=-y.pos.y-.5*y.height,A.render()}function d(){B.update(),y.update().render(),z.update().render(),A.update().render(),F.update().render();for(var a=A.cones.length-1;a>=0;--a)A.cones[a].update().render();H>=1200?H=1200:H+=6,E.style.perspective=H+"px"}function e(a){n(this),q(this),p(this),r(this),this.el=a,this.pos.x=0,this.pos.y=-170,this.pos.z=600,this.rotation.x=75,this.rotation.y=0,this.rotation.z=0,this.has360View=!0,this.set360View=function(a,b){return this.has360View=a,this.viewRotateSpeed=b,a||(F.rotation.z%=360,F.rotation.z>180&&(F.rotation.z%=180,F.rotation.z=180-F.rotation.z)),this},this.update=function(){return this.has360View?this.rotation.z+=.25:(this.rotation.z*=.97,0!==this.rotation.z&&(this.rotation.z=Math.abs(this.rotation.z)>.001?this.rotation.z:0)),this}}function f(){l(this,"cone"),n(this),q(this),p(this),r(this),o(this),this.pos.z=1,this.colors=["red","blue","gold","green"],this.coneAnimate=this.el.querySelector(".cone-animate"),this.coneAnimate.classList.add("fall"+Math.ceil(w(0,3))),this.setRandomColor=function(){var a=this.colors[Math.floor(w(0,4))];this.setColor(a)},this.setColor=function(a){this.el.className="cone",this.el.classList.add("cone-"+a)},this.update=function(){var a=this.pos.x>y.pos.x-5&&this.pos.x<y.pos.x+45,b=this.pos.y+30<y.pos.y&&this.pos.y+60>y.pos.y,c=a&&b;return c&&(this.el.classList.contains("cone-fall")||(this.rotation.z=w(0,40),body.trigger(new CustomEvent("hit-cone"))),this.el.classList.add("cone-fall")),this}}function g(a,b,c){return this.target=b,this.options=c||this.defaults,n(this),q(this),p(this),r(this),this.el=document.createElement("div"),this.el.classList.add("shadow"),this.el.classList.add(a),this.el.style.width=toInt(this.target.el.style.width)+2*this.options.padding+"px",this.el.style.height=toInt(this.target.el.style.height)+2*this.options.padding+"px",this.pos.z=2,this.update=function(){return this.pos.x=this.target.pos.x-this.options.padding,this.pos.y=this.target.pos.y-this.options.padding,this.rotation.x=this.target.rotation.x,this.rotation.z=this.target.rotation.z,this},this}function h(){return l(this,"car"),n(this),q(this),p(this),r(this),o(this),this.wheels={fl:{el:this.el.getElementsByClassName("wheel-f-l")[0]},fr:{el:this.el.getElementsByClassName("wheel-f-r")[0]},rl:{el:this.el.getElementsByClassName("wheel-r-l")[0]},rr:{el:this.el.getElementsByClassName("wheel-r-r")[0]}},this.bodyL=this.el.querySelector(".body-left"),this.bodyLT=this.el.querySelector(".body-left-top"),this.bodyR=this.el.querySelector(".body-right"),this.bodyRT=this.el.querySelector(".body-right-top"),this.wheels.fl.el.appendChild(G.wheel.content.cloneNode(!0)),this.wheels.fr.el.appendChild(G.wheel.content.cloneNode(!0)),this.wheels.rl.el.appendChild(G.wheel.content.cloneNode(!0)),this.wheels.rr.el.appendChild(G.wheel.content.cloneNode(!0)),this.width=33,this.height=100,this.pos.x=200,this.pos.y=5700,this.pos.z=2,this.speed=24,this.maxSpeed=55,this.handling=1,this.smoothness=1,this.maxLeanAngle=20,this.leanStartTime=0,this.maxTurnAngle=30,this.el.style.width=this.width+"px",this.el.style.height=this.height+"px",this.update=function(){if(this.vel){var a=this.rotation.z;a=a>this.maxTurnAngle?this.maxTurnAngle:a,a=a<-this.maxTurnAngle?-this.maxTurnAngle:a,this.rotation.z=a,this.vel.x=-this.speed*this.rotation.z/90,this.pos.x-=this.vel.x}return this},this}function i(a){function b(a){!1%a.keyCode&&a.preventDefault();var b={37:d,39:e,65:d,68:e,80:game.togglePlay.bind(game)};b[a.keyCode]&&b[a.keyCode]()}function c(a){a.preventDefault();var b={37:f,39:g,65:f,68:g};b[a.keyCode]&&b[a.keyCode]()}function d(){k=!0}function e(){j=!0}function f(){k=!1}function g(){j=!1}var h=document.body,i=a,j=!1,k=!1;return h.on("keydown",b),h.on("keyup",c),{isLeft:k,isRight:j,update:function(){var a=0;k?(a=-i.handling,i.rotation.y>-i.maxLeanAngle*(i.speed/i.maxSpeed)&&(i.rotation.y-=1)):j?(a=i.handling,i.rotation.y<i.maxLeanAngle*(i.speed/i.maxSpeed)&&(i.rotation.y+=1)):(i.rotation.z*=i.smoothness,0!==i.rotation.y&&(i.rotation.y*=.9,i.rotation.y=Math.abs(i.rotation.y)<.1?0:i.rotation.y)),i.rotation.prevZ=i.rotation.z,i.rotation.z+=a}}}function j(a){return l(this,"level"),m(this,"children"),n(this),q(this),p(this),r(this),this.width=604,this.height=2e3,this.offsetX=0,this.offsetZ=0,this.rotation.x=0,this.pos.y=0,this.gridSize=160,this.cones=[],this.conesPassed=0,this.patterns=[function(a){return a%=60,150*Math.sin(a/20*PI*2)+.5*A.width}],this.el.style.width=this.width+"px",this.el.style.height=this.height+"px",this.road={el:this.el.getElementsByClassName("road")[0]},n(this.road),this.setOptions=function(a){this.name="",a.numOfCones&&(this.numOfCones=a.numOfCones),a.topColor&&(this.topColor=a.topColor),a.botColor&&(this.botColor=a.botColor),a.speed&&(y.speed=a.speed),this.createCones(),this.changeBg(this.topColor,this.botColor)},this.changeBg=function(a,b){$(".bg-gradient").style.background=t(a,b),$(".bg-gradient").classList.add("show"),u(function(){document.body.style.background=t(a,b),$(".bg-gradient").classList.remove("show")},2e3,this)},this.createCones=function(){for(var a,b=0;b<this.numOfCones;b++)a=new f,a.setRandomColor(),a.pos.x=w(50,this.width-50),a.pos.y=b/this.numOfCones*this.height,this.add(a,"children"),this.cones.push(a);return this},this.destroyCones=function(){for(this.cones.forEach(function(a){a.el.remove()});this.cones.length>0;)this.cones.pop()},this.update=function(){var a=y.speed-Math.abs(y.vel.x);return this.road.pos.y-=a,this.road.pos.y=this.road.pos.y<-this.gridSize?this.road.pos.y%this.gridSize:this.road.pos.y,this.road.el.style.transform="translateY("+-this.road.pos.y+"px) translateZ(0px)",this.pos.x=.5*-this.width,this.pos.z=this.offsetZ,this.cones.forEach(function(b){b.pos.y+=a,b.pos.y>A.height&&(b.pos.y=50,b.pos.x=A.patterns[0](A.conesPassed),b.rotation.z=0,b.setRandomColor(),A.conesPassed++)}),this},this.setOptions(a),this}function k(){x=requestAnimationFrame(k),d()}function l(a,b){a.el=document.createElement("div"),a.el.classList.add(b),a.el.appendChild(G[b].content.cloneNode(!0))}function m(a,b){a.collections||(a.collections={}),a.collections[b]=[],a.add=function(b,c){try{a.collections[c].push(b),b.render&&a.el.appendChild(b.el)}catch(d){throw new Error("Cannot add 'undefined' to collection to "+c)}return a},a.remove=function(b,c){log("remove");var d;for(var e in a.collections[c])log(a.collections[c][e],b),d=a.collections[c][e],d==b&&(d.render&&d.el.parentNode.removeChild(d.el),a.collections[c]=a.collections[c].splice(1,e))}}function n(a){a.pos={x:0,y:0,z:0},a.moveTo=function(b,c,d){return a.pos.x=b||a.pos.x,a.pos.y=c||a.pos.y,a.pos.z=d||a.pos.z,a}}function o(a,b,c){a.minVel=b||-250,a.maxVel=c||250,a.friction=.9,a.vel={x:0,y:0,z:0},a.setVelocity=function(b,c,d){return a.vel.x=b||a.pos.x,a.vel.y=c||a.pos.y,a.vel.z=d||a.pos.z,a}}function p(a){a.scale={x:1,y:1,z:1},a.scaleTo=function(b,c,d){return a.scale.x=b||a.scale.x,a.scale.y=c||a.scale.y,a.scale.z=d||a.scale.z,a}}function q(a){a.rotation={x:0,y:0,z:0},a.rotateTo=function(b,c,d){return a.rotation.x=b||a.rotation.x,a.rotation.y=c||a.rotation.y,a.rotation.z=d||a.rotation.z,a}}function r(a){a.update=function(){return a},a.render=function(){var b={x:a.scale.x,y:a.scale.y,z:a.scale.z},c={x:a.pos.x,y:a.pos.y,z:a.pos.z},d={x:a.rotation.x,y:a.rotation.y,z:a.rotation.z};return a.el.style.transform="translate3d("+c.x+"px, "+c.y+"px, "+c.z+"px) scale3d("+b.x+", "+b.y+", "+b.z+") rotateX("+d.x+"deg) rotateZ("+d.z+"deg) rotateY("+d.y+"deg) ",a}}function s(a,b){function c(a){{var c=audioCtx.createOscillator();audioCtx.createGain()}c.type="square",c.frequency.value=a[b%l],c.connect(audioCtx.destination),c.start(0),window.osc=c,setTimeout(function(){c.stop(0)},600)}var d=261.626,e=329.628,f=220,g=293.665,h=349.228,i=195.998,j=246.942,k=[d,d,e,e,f,f,d,d,g,g,h,h,i,i,j,j],l=k.length;c(k)}function t(a,b){return"linear-gradient(180deg, "+a+" 0%, "+b+" 100%)"}function u(a,b,c){c=c?c:this,setTimeout(a.bind(c),b)}function v(){return(new Date).getTime()}function w(a,b){return Math.random()*(b-a)+a}var x,y,z,A,B,C,D=$(".game-container"),E=$("#game-canvas"),F=new e($("#game-camera")),G={car:$("#car-template"),level:$("#level-template"),wheel:$("#wheel-template"),cone:$("#cone-template"),pintoSide:$("#pinto-side-template")},H=500,I=!1,J=!0,K=0,L=[{name:"Training",numOfCones:0,speed:18,topColor:"#757F9A",botColor:"#D7DDE8"},{name:"Paradise",numOfCones:6,speed:18,topColor:"#1D2B64",botColor:"#F8CDDA"},{name:"Sea Weed",numOfCones:8,speed:18,topColor:"#4CB8C4",botColor:"#3CD3AD"},{name:"Mirage",numOfCones:10,speed:18,topColor:"#16222A",botColor:"#3A6073"},{name:"Steel Gray",numOfCones:12,speed:18,topColor:"#1F1C2C",botColor:"#928DAB"},{name:"Venice Blue",numOfCones:14,speed:18,topColor:"#085078",botColor:"#85D8CE"},{name:"Moss",numOfCones:16,speed:18,topColor:"#134E5E",botColor:"#71B280"},{name:"Influenza",numOfCones:18,speed:18,topColor:"#C04848",botColor:"#480048"}];return g.prototype.defaults={padding:0},{togglePlay:function(){return J?this.start():this.pause()},start:function(){return I||a(),J&&k(),J=!1,F.el.classList.remove("game-paused"),this},pause:function(){return cancelAnimationFrame(x),_stopTime=v(),F.el.classList.add("game-paused"),J=!0,this},setLevel:function(a){A.setOptions(L[a])},show:function(a,b){"level-select"==a&&($(".title-view").classList.add("exitOutDown"),$(".title-view").classList.remove("bounceInDown"),u(function(){$(".title-view").classList.remove("exitOutDown","animated")},1e3),$(".level-select-view").classList.add("animated","bounceInDown")),"gameplay"==a&&($(".level-select-view").classList.add("exitOutDown"),$(".level-select-view").classList.remove("bounceInDown"),u(function(){$(".level-select-view").classList.remove("exitOutDown","animated")},1e3),"pause"===this.state&&(F.set360View(!1),$(".pause-view").classList.add("exitOutDown"),$(".pause-view").classList.remove("bounceInDown"),u(function(){$(".pause-view").classList.remove("exitOutDown","animated"),game.start()},1e3)),$(".hud-view").classList.add("animated","bounceInDown"),F.set360View(!1),clearInterval(this.pauseInterval),u(function(){this.setLevel(b),game.start()},1e3,this)),"pause"==a&&(F.set360View(!0),this.pauseInterval=setInterval(function(){F.update().render()},10),$(".hud-view").classList.add("exitOutUp"),$(".hud-view").classList.remove("bounceInDown"),u(function(){$(".hud-view").classList.remove("exitOutUp","animated")},1e3),this.pause(),$(".pause-view").classList.add("animated","bounceInDown")),this.state=a}}}();