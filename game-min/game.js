/*! Boxcar Racer - v - 2014-09-08
* Copyright (c) 2014 ; Licensed  */
Element.prototype.on=Element.prototype.addEventListener,window.$=function(a){return document.querySelector(a)},window.toInt=window.parseInt,window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame,window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.oCancelAnimationFrame,window.Matrix=window.WebKitCSSMatrix||window.MSCSSMatrix||window.CSSMatrix,window.PI=Math.PI;var game=function(){function a(){G=!0,t=new h,u=new g("car-shadow",t,{padding:3}),v=new j,w=new i(t),b(),v.add(t,"children"),v.add(u,"children"),B.appendChild(v.el),d(),window.onresize=c,window.player=t,window.playerShadow=u,window.level=v}function b(){var a;for(y=[];y.length<I-1;)a=new f,a.setRandomColor(),a.pos.x=s(50,v.width-50),a.pos.y=s(50,v.height-50),v.add(a,"children"),y.push(a)}function c(){clearTimeout(x),x=setTimeout(function(){d()},300)}function d(){var a=.5*z.clientWidth-.5*v.width,b=1.3*z.clientHeight-v.height,c=.36*-z.clientHeight;t.pos.y=v.height-F*z.clientHeight,B.style.transform="rotateX(75deg) rotateZ(0deg) translateX("+a+"px) translateY("+b+"px) translateZ("+c+"px)"}function e(){w.update(),t.update().render(),u.update().render(),v.update().render(),y.forEach(function(a){a.update().render()}),D>=1200?D=1200:D+=6,A.style.perspective=D+"px"}function f(){k(this,"cone"),m(this),p(this),o(this),q(this),n(this),this.pos.z=1,this.colors=["red","blue","gold","green"],this.setRandomColor=function(){var a=this.colors[Math.floor(s(0,4))];this.el.className="cone",this.el.classList.add("cone-"+a)},this.update=function(){return this}}function g(a,b,c){return this.target=b,this.options=c||this.defaults,m(this),p(this),o(this),q(this),this.el=document.createElement("div"),this.el.classList.add("shadow"),this.el.classList.add(a),this.el.style.width=toInt(this.target.el.style.width)+2*this.options.padding+"px",this.el.style.height=toInt(this.target.el.style.height)+2*this.options.padding+"px",this.pos.z=2,this.update=function(){return this.pos.x=this.target.pos.x-this.options.padding,this.pos.y=this.target.pos.y-this.options.padding,this.rotation.x=this.target.rotation.x,this.rotation.z=this.target.rotation.z,this},this}function h(){return k(this,"car"),m(this),p(this),o(this),q(this),n(this),this.wheels={fl:{el:this.el.getElementsByClassName("wheel-f-l")[0]},fr:{el:this.el.getElementsByClassName("wheel-f-r")[0]},rl:{el:this.el.getElementsByClassName("wheel-r-l")[0]},rr:{el:this.el.getElementsByClassName("wheel-r-r")[0]}},this.bodyL=this.el.querySelector(".body-left"),this.bodyLT=this.el.querySelector(".body-left-top"),this.bodyR=this.el.querySelector(".body-right"),this.bodyRT=this.el.querySelector(".body-right-top"),this.wheels.fl.el.appendChild(C.wheel.content.cloneNode(!0)),this.wheels.fr.el.appendChild(C.wheel.content.cloneNode(!0)),this.wheels.rl.el.appendChild(C.wheel.content.cloneNode(!0)),this.wheels.rr.el.appendChild(C.wheel.content.cloneNode(!0)),this.width=33,this.height=100,this.pos.x=200,this.pos.y=5700,this.pos.z=2,this.speed=18,this.handling=1,this.smoothness=1,this.leaning=.99,this.maxLeanAngle=15,this.leanStartTime=0,this.maxTurnAngle=30,this.el.style.width=this.width+"px",this.el.style.height=this.height+"px",this.update=function(){if(this.vel){var a=this.rotation.z;a=a>this.maxTurnAngle?this.maxTurnAngle:a,a=a<-this.maxTurnAngle?-this.maxTurnAngle:a,this.rotation.z=a,v.pos.x=.4*(-t.pos.x+.5*v.width),this.vel.x=-this.speed*this.rotation.z/90,this.pos.x-=this.vel.x,this.calcLean()}return this},this.calcLean=function(){{var a="50% 50%";this.rotation.z*this.leaning,this.rotation.z-this.rotation.prevZ}a=this.rotation.y>1?"100% 50%":a,a=this.rotation.y<-1?"0% 50%":a,this.el.style.transformOrigin=a},this.turnWheels=function(a){var b=a/this.maxTurnAngle*PI-.5*PI,c=Math.cos(b)*this.maxTurnAngle;return this.wheels.fl.el.style.transform="rotateY(90deg) translateX(-16px) rotateX("+c+"deg)",this.wheels.fr.el.style.transform="rotateY(90deg) translateX(-16px) rotateX("+c+"deg)",this},this}function i(a){function b(a){a.preventDefault();var b={37:d,39:e,65:d,68:e};b[a.keyCode]&&b[a.keyCode]()}function c(a){a.preventDefault();var b={37:f,39:g,65:f,68:g};b[a.keyCode]&&b[a.keyCode]()}function d(){k=!0}function e(){j=!0}function f(){k=!1}function g(){j=!1}var h=document.body,i=a,j=!1,k=!1;return h.on("keydown",b),h.on("keyup",c),{isLeft:k,isRight:j,update:function(){var a=0;k?a=-i.handling:j?a=i.handling:i.rotation.z*=i.smoothness,i.rotation.prevZ=i.rotation.z,i.rotation.z+=a}}}function j(){return k(this,"level"),l(this,"children"),m(this),p(this),q(this),this.width=800,this.height=2400,this.rotation.x=0,this.pos.y=0,this.gridSize=160,this.el.style.width=this.width+"px",this.el.style.height=this.height+"px",this.road={el:this.el.getElementsByClassName("road")[0]},m(this.road),this.update=function(){var a=t.speed-Math.abs(t.vel.x);return this.road.pos.y-=a,this.road.pos.y=this.road.pos.y<-this.gridSize?this.road.pos.y%this.gridSize:this.road.pos.y,this.road.el.style.transform="translateY("+-this.road.pos.y+"px) translateZ(0px)",y.forEach(function(b){b.pos.y+=a,b.pos.y>v.height&&(b.pos.y=50,b.pos.x=s(0,v.width-50),b.setRandomColor())}),this},this}function k(a,b){a.el=document.createElement("div"),a.el.classList.add(b),a.el.appendChild(C[b].content.cloneNode(!0))}function l(a,b){a.collections||(a.collections={}),a.collections[b]=[],a.add=function(b,c){try{a.collections[c].push(b),b.render&&a.el.appendChild(b.el)}catch(d){throw new Error("Cannot add 'undefined' to collection to "+c)}return a},a.remove=function(b,c){log("remove");var d;for(var e in a.collections[c])log(a.collections[c][e],b),d=a.collections[c][e],d==b&&(d.render&&d.el.parentNode.removeChild(d.el),a.collections[c]=a.collections[c].splice(1,e))}}function m(a){a.pos={x:0,y:0,z:0},a.moveTo=function(b,c,d){return a.pos.x=b||a.pos.x,a.pos.y=c||a.pos.y,a.pos.z=d||a.pos.z,a}}function n(a,b,c){a.minVel=b||-250,a.maxVel=c||250,a.friction=.9,a.vel={x:0,y:0,z:0},a.setVelocity=function(b,c,d){return a.vel.x=b||a.pos.x,a.vel.y=c||a.pos.y,a.vel.z=d||a.pos.z,a}}function o(a){a.scale={x:1,y:1,z:1},a.scaleTo=function(b,c,d){return a.scale.x=b||a.scale.x,a.scale.y=c||a.scale.y,a.scale.z=d||a.scale.z,a}}function p(a){a.rotation={x:0,y:0,z:0},a.rotateTo=function(b,c,d){return a.rotation.x=b||a.rotation.x,a.rotation.y=c||a.rotation.y,a.rotation.z=d||a.rotation.z,a}}function q(a){a.update=function(){return a},a.render=function(){var b={x:a.scale?a.scale.x:1,y:a.scale?a.scale.y:1,z:a.scale?a.scale.z:1},c={x:a.pos.x,y:a.pos.y,z:a.pos.z},d={x:a.rotation.x,y:a.rotation.y,z:a.rotation.z};return a.el.style.transform="translate3d("+c.x+"px, "+c.y+"px, "+c.z+"px) scale3d("+b.x+", "+b.y+", "+b.z+") rotateX("+d.x+"deg) rotateZ("+d.z+"deg) rotateY("+d.y+"deg) ",a}}function r(){return(new Date).getTime()}function s(a,b){return Math.random()*(b-a)+a}var t,u,v,w,x,y,z=$(".game-container"),A=$("#game-canvas"),B=$("#game-scene"),C={car:$("#car-template"),level:$("#level-template"),wheel:$("#wheel-template"),cone:$("#cone-template"),pintoSide:$("#pinto-side-template")},D=500,E=null,F=.45,G=!1,H=!0,I=12;return console.log("_container",z),g.prototype.defaults={padding:0},{togglePlay:function(){return H?this.start():this.stop()},start:function(){return G||(E=r(),a()),H&&this.step(),H=!1,B.classList.remove("game-paused"),this},stop:function(){return cancelAnimationFrame(this.requestId),_stopTime=r(),B.classList.add("game-paused"),H=!0,this},step:function(a){var b;null===E&&(E=a),b=a-E,this.requestId=requestAnimationFrame(this.step.bind(this)),e()}}}();