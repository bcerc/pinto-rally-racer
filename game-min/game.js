/*! Boxcar Racer - v - 2014-09-13
* Copyright (c) 2014 ; Licensed  */
Element.prototype.on=Element.prototype.addEventListener,Element.prototype.off=Element.prototype.removeEventListener,Element.prototype.index=function(a){for(var b=0;b<this.children.length;b++)if(a==this.children[b])return b;return 0},EventTarget.prototype.trigger=EventTarget.prototype.dispatchEvent,window.$=function(a){var b=document.querySelectorAll(a);return 1===b.length?b[0]:b},window.toInt=window.parseInt,window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame,window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.oCancelAnimationFrame,window.Matrix=window.WebKitCSSMatrix||window.MSCSSMatrix||window.CSSMatrix,window.PI=Math.PI,window.audioCtx=new(window.AudioContext||window.webkitAudioContext),window.store=window.localStorage,window.body=document.body;var game=function(){function a(){N=!0,D=new h,E=new g("car-shadow",D,{padding:3}),F=new j(P[0]),G=new i(D),F.destroyCones(),$(".title-view").classList.add("animated","bounceInDown"),F.add(D,"children"),F.add(E,"children"),K.el.appendChild(F.el),c(),body.on("hit-cone",function(a){var b=a.detail.cone,c=1;F.numConesHit++,F.numCombo++,F.numCombo>3&&($(".combo-counter").innerText=F.numCombo,$(".combo-counter-animate").classList.add("show")),b&&"gold"===b.color&&(c=4,t("triangle",F.numConesHit,!0)),t("sine",F.numConesHit),c=F.score+c,F.setScore(c),F.percentComplete()>=100&&F.finished()});for(var a,d,e,f=0;f<P.length;f++)a=P[f],d=x("button"),d.innerText=a.name,e=x("div"),e.className="level-time",e.innerText=a.userTime,d.appendChild(e),d.style.backgroundImage=y(a.topColor,a.botColor),$(".levels").appendChild(d);$(".levels").on("click",function(a){if(a.target!==a.currentTarget){var b=a.currentTarget.index(a.target);F.restart(),game.setLevel(b),game.setView("hud-view"),game.start()}}),window.onresize=b,window.player=D,window.playerShadow=E,window.level=F,window.camera=K}function b(){clearTimeout(H),H=setTimeout(function(){c()},300)}function c(){K.render(),D.pos.y=F.height-200,F.offsetZ=.36*-I.clientHeight,F.pos.y=-D.pos.y-.5*D.height,F.render()}function d(){G.update(),D.update().render(),E.update().render(),F.update().render(),K.update().render();for(var a=F.cones.length-1;a>=0;--a)F.cones[a]&&F.cones[a].update().render();M>=1200?M=1200:M+=6,J.style.perspective=M+"px"}function e(a){o(this),r(this),q(this),s(this),this.el=a,this.pos.x=0,this.pos.y=-170,this.pos.z=600,this.rotation.x=75,this.rotation.y=0,this.rotation.z=0,this.has360View=!0,this.set360View=function(a,b){return this.has360View=a,this.viewRotateSpeed=b,a||(K.rotation.z%=360,K.rotation.z>180&&(K.rotation.z%=180,K.rotation.z=180-K.rotation.z)),this},this.update=function(){return this.has360View?this.rotation.z+=.25:(this.rotation.z*=.97,0!==this.rotation.z&&(this.rotation.z=Math.abs(this.rotation.z)>.001?this.rotation.z:0)),this}}function f(a){m(this,"cone"),o(this),r(this),q(this),s(this),p(this),this.setHidden=function(a){return a?this.el.classList.add("hide"):this.el.classList.remove("hide"),b=a,this},this.isHidden=function(){return b},this.setColor=function(a){return this.color=a,this.el.classList.remove("cone-blue"),this.el.classList.remove("cone-red"),this.el.classList.remove("cone-gold"),this.el.classList.remove("cone-green"),this.el.classList.add("cone-"+a),this},this.reset=function(){return this.isHit=!1,this.el.classList.remove("cone-fall"),this},this.update=function(){var a=this.pos.x>D.pos.x-20&&this.pos.x<D.pos.x+35,c=this.pos.y+30<D.pos.y&&this.pos.y+60>D.pos.y,d=a&&c&&!b;return d&&(this.el.classList.contains("cone-fall")||(this.rotation.z=B(0,40),body.trigger(new CustomEvent("hit-cone",{detail:{cone:this}}))),this.el.classList.add("cone-fall"),this.isHit=!0),this.pos.y>D.pos.y&&!this.isHit&&(F.numCombo=0,$(".combo-counter-animate").classList.contains("show")&&z(function(){$(".combo-counter-animate").classList.remove("show")},200)),this};var b=!1;this.el.classList.add("cone"),this.pos.z=1,this.coneAnimate=this.el.querySelector(".cone-animate"),this.coneAnimate.classList.add("fall"+Math.ceil(B(0,3))),this.setColor(a||"blue")}function g(a,b,c){return this.target=b,this.options=c||this.defaults,o(this),r(this),q(this),s(this),this.update=function(){return this.pos.x=this.target.pos.x-this.options.padding,this.pos.y=this.target.pos.y-this.options.padding,this.rotation.x=this.target.rotation.x,this.rotation.z=this.target.rotation.z,this},this.el=x("div"),this.el.classList.add("shadow"),this.el.classList.add(a),this.el.style.width=toInt(this.target.el.style.width)+2*this.options.padding+"px",this.el.style.height=toInt(this.target.el.style.height)+2*this.options.padding+"px",this.pos.z=2,this}function h(){return m(this,"car"),o(this),r(this),q(this),s(this),p(this),this.wheels={fl:{el:this.el.getElementsByClassName("wheel-f-l")[0]},fr:{el:this.el.getElementsByClassName("wheel-f-r")[0]},rl:{el:this.el.getElementsByClassName("wheel-r-l")[0]},rr:{el:this.el.getElementsByClassName("wheel-r-r")[0]}},this.bodyL=this.el.querySelector(".body-left"),this.bodyLT=this.el.querySelector(".body-left-top"),this.bodyR=this.el.querySelector(".body-right"),this.bodyRT=this.el.querySelector(".body-right-top"),this.wheels.fl.el.appendChild(L.wheel.content.cloneNode(!0)),this.wheels.fr.el.appendChild(L.wheel.content.cloneNode(!0)),this.wheels.rl.el.appendChild(L.wheel.content.cloneNode(!0)),this.wheels.rr.el.appendChild(L.wheel.content.cloneNode(!0)),this.width=33,this.height=100,this.pos.x=200,this.pos.y=5700,this.pos.z=2,this.speed=24,this.maxSpeed=55,this.handling=1,this.smoothness=1,this.maxLeanAngle=20,this.leanStartTime=0,this.maxTurnAngle=30,this.el.style.width=this.width+"px",this.el.style.height=this.height+"px",this.boost=function(){return Math.floor(F.numCombo/1)},this.update=function(){var a=this.rotation.z;return a=a>this.maxTurnAngle?this.maxTurnAngle:a,a=a<-this.maxTurnAngle?-this.maxTurnAngle:a,this.rotation.z=a,this.vel.x=-this.speed*this.rotation.z/90,this.pos.x-=this.vel.x,this},this}function i(a){function b(a){!1%a.keyCode&&a.preventDefault();var b={37:d,39:e,65:d,68:e,80:game.togglePlay.bind(game)};b[a.keyCode]&&b[a.keyCode]()}function c(a){a.preventDefault();var b={37:f,39:g,65:f,68:g};b[a.keyCode]&&b[a.keyCode]()}function d(){k=!0}function e(){j=!0}function f(){k=!1}function g(){j=!1}var h=document.body,i=a,j=!1,k=!1;return h.on("keydown",b),h.on("keyup",c),{isLeft:k,isRight:j,update:function(){var a=0;k?(a=-i.handling,i.rotation.y>-i.maxLeanAngle*(i.speed/i.maxSpeed)&&(i.rotation.y-=1)):j?(a=i.handling,i.rotation.y<i.maxLeanAngle*(i.speed/i.maxSpeed)&&(i.rotation.y+=1)):(i.rotation.z*=i.smoothness,0!==i.rotation.y&&(i.rotation.y*=.9,i.rotation.y=Math.abs(i.rotation.y)<.1?0:i.rotation.y)),i.rotation.prevZ=i.rotation.z,i.rotation.z+=a}}}function j(a){return m(this,"level"),n(this,"children"),o(this),r(this),q(this),s(this),this.width=604,this.height=2e3,this.offsetX=0,this.offsetZ=0,this.rotation.x=0,this.pos.y=0,this.gridSize=160,this.cones=[],this.conesPassed=0,this.guardOffset=-10,this.numConesHit=0,this.numCombo=0,this.coneColors=[],this.score=0,this.timer=$("#timer"),this.completedTime=$("#completed-time"),this.startTime=0,this.endTime=0,this.offsetTime=0,this.patterns=[u(.5,70,10,1)],this.el.style.width=this.width+"px",this.el.style.height=this.height+"px",this.road={el:this.el.getElementsByClassName("road")[0]},o(this.road),this.setOptions=function(a){for(var b in a)this[b]=a[b];this.changeBg(this.topColor,this.botColor),this.restart()},this.setScore=function(a){this.score=a,$(".progress-fill").style.width=this.percentComplete()+"%"},this.pause=function(){this.pauseStartTime=A()},this.unpause=function(){this.offsetTime+=A()-this.pauseStartTime},this.changeBg=function(a,b){$(".bg-gradient").style.background=y(a,b),$(".bg-gradient").classList.add("show"),z(function(){document.body.style.background=y(a,b),$(".bg-gradient").classList.remove("show")},2e3,this)},this.restart=function(){this.setScore(0),this.numConesHit=0,this.destroyCones(),this.startTime=0,this.endTime=0,this.offsetTime=0,this.numCombo=0,this.isFinished=!1,$(".combo-counter-animate").classList.remove("show"),this.start()},this.start=function(){this.createCones(),this.startTime=A(),this.pauseStartTime=0},this.elapsedTime=function(){var a=Math.floor(.1*(this.endTime-this.startTime-this.offsetTime));return(.01*a).toFixed(2)},this.percentComplete=function(){return this.score/this.scoreToWin*100},this.isBestTime=function(a,b){var c=parseFloat(w("lvl"+a+"time"))||Number.MAX_VALUE;return c>b},this.createCones=function(){for(var a,b=0;b<this.numCones;b++)a=new f(this.getRandomConeColor()),a.setHidden(!0),a.pos.x=B(20,this.width-20),a.pos.y=b/this.numCones*this.height,this.add(a,"children"),this.cones.push(a);return this},this.destroyCones=function(){for(this.cones.forEach(function(a){a.el.remove()});this.cones.length>0;)this.cones.pop()},this.getRandomConeColor=function(){var a=Math.floor(B(0,this.coneColors.length)),b=this.coneColors[a];return B(0,1)<this.bonusConeRatio&&(b="gold"),b},this.finished=function(){var a,b=game.levelIndex;this.isFinished=!0,this.destroyCones(),z(function(){l("complete-view")},1e3),this.endTime=A(),a=this.elapsedTime(),this.completedTime.innerText=a,this.isBestTime(b,a)?($(".complete-view").classList.add("best-time"),v("lvl"+b+"time",a),$(".level-time")[b].innerText=a):$(".complete-view").classList.remove("best-time")},this.update=function(){this.isFinished||(this.endTime=A()),this.timer.innerHTML=this.elapsedTime();var a=this.speed+D.boost()-Math.abs(D.vel.x);this.road.pos.y-=a,this.road.pos.y=this.road.pos.y<-this.gridSize?this.road.pos.y%this.gridSize:this.road.pos.y,this.road.el.style.transform="translateY("+-this.road.pos.y+"px) translateZ(0px)",this.pos.x=.5*-this.width,this.pos.z=this.offsetZ,this.cones.forEach(function(b){b.pos.y+=a,b.pos.y>F.height&&(b.setHidden(!1).reset(!1),b.pos.y=0,b.pos.x=F.patterns[0](F.conesPassed),b.rotation.z=0,b.setColor(F.getRandomConeColor()),F.conesPassed++)});var b=this.width+this.guardOffset-.5*D.width;return D.pos.x<-this.guardOffset?D.pos.x=-this.guardOffset:D.pos.x>b&&(D.pos.x=b),this},this.setOptions(a),this}function k(){C=requestAnimationFrame(k),d()}function l(a,b){var c=["title-view","instructions-view","level-select-view","pause-view","hud-view","complete-view"],d="pause-view"===a;c.forEach(function(b){a===b||"hud-view"===b&&d||($("."+b).classList.add("exitOutDown"),$("."+b).classList.remove("bounceInDown"))}),z(function(){c.forEach(function(b){a===b||"hud-view"===b&&d||$("."+b).classList.remove("exitOutDown","animated")})},800),$("."+a).classList.add("animated","bounceInDown"),"pause-view"===a&&(K.set360View(!0),clearInterval(this.pauseInterval),F.pause(),this.pauseInterval=setInterval(function(){K.update().render()},10),game.pause()),"hud-view"===a&&(K.set360View(!1),"pause-view"===this.prevView&&z(function(){b||F.unpause(),game.start()},1e3)),"complete-view"===a&&(game.levelIndex>=P.length-1?$(".btn-next-level").classList.add("hide"):$(".btn-next-level").classList.remove("hide")),this.prevView=a}function m(a,b){a.el=x("div"),a.el.classList.add(b),a.el.appendChild(L[b].content.cloneNode(!0))}function n(a,b){a.collections||(a.collections={}),a.collections[b]=[],a.add=function(b,c){try{a.collections[c].push(b),b.render&&a.el.appendChild(b.el)}catch(d){throw new Error("Cannot add 'undefined' to collection to "+c)}return a},a.remove=function(b,c){log("remove");var d;for(var e in a.collections[c])log(a.collections[c][e],b),d=a.collections[c][e],d==b&&(d.render&&d.el.parentNode.removeChild(d.el),a.collections[c]=a.collections[c].splice(1,e))}}function o(a){a.pos={x:0,y:0,z:0}}function p(a,b,c){a.minVel=b||-250,a.maxVel=c||250,a.vel={x:0,y:0,z:0}}function q(a){a.scale={x:1,y:1,z:1}}function r(a){a.rotation={x:0,y:0,z:0}}function s(a){a.update=function(){return a},a.render=function(){var b={x:a.scale.x,y:a.scale.y,z:a.scale.z},c={x:a.pos.x,y:a.pos.y,z:a.pos.z},d={x:a.rotation.x,y:a.rotation.y,z:a.rotation.z};return a.el.style.transform="translate3d("+c.x+"px, "+c.y+"px, "+c.z+"px) scale3d("+b.x+", "+b.y+", "+b.z+") rotateX("+d.x+"deg) rotateZ("+d.z+"deg) rotateY("+d.y+"deg) ",a}}function t(a,b,c){function d(a,d){var e=audioCtx.createOscillator(),f=audioCtx.createGain();e.type=d,e.frequency.value=a[b%m],e.connect(f),f.connect(audioCtx.destination),f.gain.value=c?.7:.5,e.start(0),setTimeout(function(){e.stop(0)},600)}var e=261.626,f=329.628,g=220,h=293.665,i=349.228,j=195.998,k=246.942,l=[e,e,f,f,g,g,e,e,h,h,i,i,j,j,k,k],m=l.length;d(l,a)}function u(a,b,c,d){return function(e){var f=d*(e%b);return a*F.width*.5*Math.sin(f/c*PI*2)+.5*F.width}}function v(a,b){store.setItem(a,b)}function w(a){return store.getItem(a)}function x(a){return document.createElement(a)}function y(a,b){return"linear-gradient(180deg, "+a+" 0%, "+b+" 100%)"}function z(a,b,c){return c=c?c:this,setTimeout(a.bind(c),b)}function A(){return(new Date).getTime()}function B(a,b){return Math.random()*(b-a)+a}var C,D,E,F,G,H,I=$(".game-container"),J=$("#game-canvas"),K=new e($("#game-camera")),L={car:$("#car-template"),level:$("#level-template"),wheel:$("#wheel-template"),cone:$("#cone-template"),pintoSide:$("#pinto-side-template")},M=500,N=!1,O=!0,P=[{name:"Twin Peaks",numCones:4,coneColors:["blue"],bonusConeRatio:.2,scoreToWin:50,userTime:w("lvl0time")||"0.00",speed:18,topColor:"#1D2B64",botColor:"#F8CDDA",patterns:[u(.5,70,10,1)]},{name:"Stinson",numCones:8,coneColors:["blue"],bonusConeRatio:.1,scoreToWin:70,userTime:w("lvl1time")||"0.00",speed:24,topColor:"#4CB8C4",botColor:"#3CD3AD",patterns:[u(.15,40,70,1)]},{name:"Big Basin",numCones:12,coneColors:["green"],bonusConeRatio:0,scoreToWin:10,userTime:w("lvl2time")||"0.00",speed:24,topColor:"#16222A",botColor:"#3A6073",patterns:[u(.5,70,10,1)]},{name:"Alcatraz",numCones:4,coneColors:["red"],bonusConeRatio:.6,scoreToWin:120,userTime:w("lvl3time")||"0.00",speed:30,topColor:"#1F1C2C",botColor:"#928DAB",patterns:[function(){return B(120,F.width-120)}]},{name:"Ocean Beach",numCones:14,coneColors:["green"],bonusConeRatio:0,scoreToWin:10,userTime:w("lvl4time")||"0.00",speed:24,topColor:"#085078",botColor:"#85D8CE",patterns:[u(.5,70,10,1)]},{name:"Muir Woods",numCones:8,coneColors:["green"],bonusConeRatio:.5,scoreToWin:40,userTime:w("lvl5time")||"0.00",speed:22,topColor:"#134E5E",botColor:"#71B280",patterns:[u(.6,70,5,1)]},{name:"San Quentin",numCones:12,coneColors:["red"],bonusConeRatio:.4,scoreToWin:180,userTime:w("lvl6time")||"0.00",speed:24,topColor:"#C04848",botColor:"#480048",patterns:[function(a){return a=B(0,10*a),a%=F.width-300,a+=150}]},{name:"The Abyss",numCones:32,coneColors:["red"],bonusConeRatio:.666,scoreToWin:60,userTime:w("lvl7time")||"0.00",speed:46,topColor:"#000",botColor:"#000",patterns:[function(){return B(50,F.width-50)}]}];return g.prototype.defaults={padding:0},{togglePlay:function(){return O?this.start():this.pause()},start:function(){return N||a(),O&&k(),O=!1,K.el.classList.remove("game-paused"),this},pause:function(){return cancelAnimationFrame(C),_stopTime=A(),K.el.classList.add("game-paused"),O=!0,this},setLevel:function(a){return game.levelIndex=a,K.set360View(!1),F.setOptions(P[a]),this},nextLevel:function(){var a=game.levelIndex+1;return game.setLevel(a).start(),l("hud-view"),F.restart(),this},restartLevel:function(){l("hud-view",!0),F.restart()},exit:function(){l("title-view"),F.destroyCones(),game.start()},setView:function(a){l(a)}}}();