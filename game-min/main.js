/*! Super Pinto Rally Racer - v0.9 - 2014-09-17
* Copyright (c) 2014 ; Licensed  */
function Template(a){return $("#"+a+"-template").content.cloneNode(!0)}function Templatable(a,b){a.el=el("div"),a.el.classList.add(b),a.el.appendChild(Template([b]))}function Collectable(a,b){a.collections||(a.collections={}),a.collections[b]=[],a.add=function(b,c){try{a.collections[c].push(b),b.render&&a.el.appendChild(b.el)}catch(d){throw new Error("Cannot add 'undefined' to collection to "+c)}return a},a.remove=function(b,c){log("remove");var d;for(var e in a.collections[c])log(a.collections[c][e],b),d=a.collections[c][e],d==b&&(d.render&&d.el.parentNode.removeChild(d.el),a.collections[c]=a.collections[c].splice(1,e))}}function Positionable(a){a.pos={x:0,y:0,z:0}}function Physicsable(a,b,c){a.minVel=b||-250,a.maxVel=c||250,a.vel={x:0,y:0,z:0}}function Scalable(a){a.scale={x:1,y:1,z:1}}function Rotatable(a){a.rotation={x:0,y:0,z:0}}function Renderable(a){a.update=function(){return a},a.render=function(){var b={x:a.scale.x,y:a.scale.y,z:a.scale.z},c={x:a.pos.x,y:a.pos.y,z:a.pos.z},d={x:a.rotation.x,y:a.rotation.y,z:a.rotation.z};return a.el.style.transform="translate3d("+c.x+"px, "+c.y+"px, "+c.z+"px) scale3d("+b.x+", "+b.y+", "+b.z+") rotateX("+d.x+"deg) rotateZ("+d.z+"deg) rotateY("+d.y+"deg) ",a}}Element.prototype.on=Element.prototype.addEventListener,Element.prototype.off=Element.prototype.removeEventListener,Element.prototype.index=function(a){for(var b=0;b<this.children.length;b++)if(a==this.children[b])return b;return 0},EventTarget.prototype.trigger=EventTarget.prototype.dispatchEvent,window.$=function(a){var b=document.querySelectorAll(a);return 1===b.length?b[0]:b},window.toInt=window.parseInt,window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame,window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.oCancelAnimationFrame,window.Matrix=window.WebKitCSSMatrix||window.MSCSSMatrix||window.CSSMatrix,window.PI=Math.PI,window.audioCtx=new(window.AudioContext||window.webkitAudioContext),window.body=document.body,window.save=function(a,b){window.localStorage.setItem(a,b)},window.retreive=function(a){return window.localStorage.getItem(a)},window.el=function(a){return document.createElement(a)},window.linearGradient=function(a,b){return"linear-gradient(180deg, "+a+" 0%, "+b+" 100%)"},window.delay=function(a,b,c){return c=c?c:this,setTimeout(a.bind(c),b)},window.time=function(){return(new Date).getTime()},window.rand=function(a,b){return Math.random()*(b-a)+a};var Audio=function(){function a(a,b,c){var d=audioCtx.createOscillator(),e=audioCtx.createGain();d.type=b,d.frequency.value=i[a%i.length],d.connect(e),e.connect(audioCtx.destination),e.gain.value=c,d.start(0),setTimeout(function(){d.stop(0)},600)}var b=261.626,c=329.628,d=220,e=293.665,f=349.228,g=195.998,h=246.942,i=[b,b,c,c,d,d,b,b,e,e,f,f,g,g,h,h];return{playNote:function(b,c){var d=c?"triangle":"sine",e=c?.7:.5;a(b,d,e)}}}(),Camera=function(){return{create:function(a){var b={};return Positionable(b),Rotatable(b),Scalable(b),Renderable(b),b.el=$(a),b.pos.x=0,b.pos.y=-170,b.pos.z=600,b.rotation.x=75,b.rotation.y=0,b.rotation.z=0,b.has360View=!0,b.set360View=function(a,c){return b.has360View=a,b.viewRotateSpeed=c,a||(b.rotation.z%=360,b.rotation.z>180&&(b.rotation.z%=180,b.rotation.z=180-b.rotation.z)),b},b.update=function(){return b.has360View?b.rotation.z+=.25:(b.rotation.z*=.97,0!==b.rotation.z&&(b.rotation.z=Math.abs(b.rotation.z)>.001?b.rotation.z:0)),b},b}}}(),Cone=function(){return{create:function(a,b){var c={},d={x:0,y:0};Templatable(c,"cone"),Positionable(c),Rotatable(c),Scalable(c),Renderable(c),Physicsable(c),c.width=20,c.height=20,c.padding=3,c.setHidden=function(a){return a?c.el.classList.add("hide"):c.el.classList.remove("hide"),e=a,c},c.isHidden=function(){return e},c.setColor=function(a){return c.color=a,c.el.classList.remove("cone-blue"),c.el.classList.remove("cone-red"),c.el.classList.remove("cone-gold"),c.el.classList.remove("cone-green"),c.el.classList.add("cone-"+a),c},c.reset=function(){return c.isHit=!1,c.el.classList.remove("cone-fall"),c},c.worldToPlayer=function(){var a=b.rotation.z*(Math.PI/180),e=b.pos.x-c.pos.x,f=b.pos.y-c.pos.y;d.x=-Math.cos(a)*e-Math.sin(a)*f,d.y=Math.sin(a)*e+Math.cos(a)*f},c.checkCollision=function(a){var d=a.x>-c.width-c.padding&&a.x<b.width+c.padding,f=a.y<c.height&&a.y>-b.height,g=d&&f&&!e;return g},c.update=function(){c.worldToPlayer();var a=c.checkCollision(d);return a&&!c.isHit&&(c.el.classList.contains("cone-fall")||(c.rotation.z=rand(0,40),body.trigger(new CustomEvent("hit-cone",{detail:{cone:c}}))),c.el.classList.add("cone-fall"),c.isHit=!0),c.pos.y>b.pos.y+b.height&&!c.isHit&&(body.trigger(new CustomEvent("reset-cone-combo")),$(".combo-counter-animate").classList.contains("show")&&delay(function(){$(".combo-counter-animate").classList.remove("show")},200)),c.prevX=d.x,c.prevY=d.y,c};var e=!1;return c.el.classList.add("cone"),c.pos.z=1,c.coneAnimate=c.el.querySelector(".cone-animate"),c.coneAnimate.classList.add("fall"+Math.ceil(rand(0,3))),c.setColor(a||"blue"),c}}}(),Level=function(){return{create:function(a,b){var c={};return Templatable(c,"level"),Collectable(c,"children"),Positionable(c),Rotatable(c),Scalable(c),Renderable(c),body.on("reset-cone-combo",function(){c.numCombo=0}),c.width=604,c.height=2e3,c.offsetX=0,c.offsetZ=0,c.rotation.x=0,c.pos.y=0,c.gridSize=160,c.cones=[],c.conesPassed=0,c.guardOffset=-10,c.numConesHit=0,c.numCombo=0,c.coneColors=[],c.score=0,c.timer=$("#timer"),c.completedTime=$("#completed-time"),c.startTime=0,c.endTime=0,c.offsetTime=0,c.el.style.width=c.width+"px",c.el.style.height=c.height+"px",c.road={el:c.el.getElementsByClassName("road")[0]},Positionable(c.road),c.setOptions=function(a){for(var b in a)c[b]=a[b];c.changeBg(c.topColor,c.botColor),c.restart()},c.setScore=function(a){c.score=a,$(".progress-fill").style.width=c.percentComplete()+"%"},c.pause=function(){c.pauseStartTime=time()},c.unpause=function(){c.offsetTime+=time()-c.pauseStartTime},c.changeBg=function(a,b){$(".bg-gradient").style.background=linearGradient(a,b),$(".bg-gradient").classList.add("show"),delay(function(){document.body.style.background=linearGradient(a,b),$(".bg-gradient").classList.remove("show")},2e3,c)},c.restart=function(){c.setScore(0),c.numConesHit=0,c.destroyCones(),c.startTime=0,c.endTime=0,c.offsetTime=0,c.numCombo=0,c.isFinished=!1,$(".combo-counter-animate").classList.remove("show"),c.start()},c.start=function(){c.createCones(),c.startTime=time(),c.pauseStartTime=0},c.elapsedTime=function(){var a=Math.floor(.1*(c.endTime-c.startTime-c.offsetTime));return(.01*a).toFixed(2)},c.percentComplete=function(){return c.score/c.scoreToWin*100},c.isBestTime=function(a,b){var c=parseFloat(retreive("lvl"+a+"time"))||Number.MAX_VALUE;return c>b},c.createCones=function(){for(var a,d=0;d<c.numCones;d++)a=Cone.create(c.getRandomConeColor(),b),a.setHidden(!0),a.pos.x=rand(20,c.width-20),a.pos.y=d/c.numCones*c.height,c.add(a,"children"),c.cones.push(a);return c},c.destroyCones=function(){for(c.cones.forEach(function(a){a.el.remove()});c.cones.length>0;)c.cones.pop()},c.getRandomConeColor=function(){var a=Math.floor(rand(0,c.coneColors.length)),b=c.coneColors[a];return rand(0,1)<c.bonusConeRatio&&(b="gold"),b},c.finished=function(){var a,b=game.levelIndex;c.isFinished=!0,c.destroyCones(),delay(function(){body.trigger(new CustomEvent("change-view",{detail:"complete-view"}))},1e3),c.endTime=time(),a=c.elapsedTime(),c.completedTime.innerText=a,save("lvl"+b+"combo",c.userCombo),$(".level-combo")[b].innerText=c.userCombo,c.isBestTime(b,a)?($(".complete-view").classList.add("best-time"),save("lvl"+b+"time",a),$(".level-time")[b].innerText=a):$(".complete-view").classList.remove("best-time")},c.update=function(){c.isFinished||(c.endTime=time()),c.timer.innerHTML=c.elapsedTime();var a=c.speed+Math.floor(c.numCombo/1)-Math.abs(b.vel.x),d=c;c.road.pos.y-=a,c.road.pos.y=c.road.pos.y<-c.gridSize?c.road.pos.y%c.gridSize:c.road.pos.y,c.road.el.style.transform="translateY("+-c.road.pos.y+"px) translateZ(0px)",c.pos.x=.5*-c.width,c.pos.z=c.offsetZ,c.cones.forEach(function(b){b.pos.y+=a,b.pos.y>d.height&&(b.setHidden(!1).reset(!1),b.pos.y=0,b.pos.x=d.patterns[0](d.conesPassed),b.rotation.z=0,b.setColor(d.getRandomConeColor()),d.conesPassed++)});var e=c.width+c.guardOffset-.5*b.width;return b.pos.x<-c.guardOffset?b.pos.x=-c.guardOffset:b.pos.x>e&&(b.pos.x=e),c},c.setOptions(a),c}}}(),LevelMenuItem=function(){return{create:function(a){var b,c=el("button"),d=retreive("lvl"+a.id+"time")||"0.00",e=retreive("lvl"+a.id+"combo")||"0";return b=new Template("level-menu-item"),b.querySelector(".level-title").innerText=a.name,b.querySelector(".level-time").innerText=d,b.querySelector(".level-combo").innerText=e,a.userCombo=e,c.appendChild(b),c.style.backgroundImage=linearGradient(a.topColor,a.botColor),c}}}(),Player=function(){return{create:function(){var a={};return Templatable(a,"player"),Positionable(a),Rotatable(a),Scalable(a),Renderable(a),Physicsable(a),a.wheels={fl:{el:a.el.getElementsByClassName("wheel-f-l")[0]},fr:{el:a.el.getElementsByClassName("wheel-f-r")[0]},rl:{el:a.el.getElementsByClassName("wheel-r-l")[0]},rr:{el:a.el.getElementsByClassName("wheel-r-r")[0]}},a.bodyL=a.el.querySelector(".body-left"),a.bodyLT=a.el.querySelector(".body-left-top"),a.bodyR=a.el.querySelector(".body-right"),a.bodyRT=a.el.querySelector(".body-right-top"),a.wheels.fl.el.appendChild(new Template("wheel")),a.wheels.fr.el.appendChild(new Template("wheel")),a.wheels.rl.el.appendChild(new Template("wheel")),a.wheels.rr.el.appendChild(new Template("wheel")),a.width=33,a.height=100,a.pos.x=200,a.pos.y=5700,a.pos.z=2,a.speed=24,a.maxSpeed=55,a.handling=1,a.smoothness=1,a.maxLeanAngle=20,a.leanStartTime=0,a.maxTurnAngle=30,a.el.style.width=a.width+"px",a.el.style.height=a.height+"px",a.update=function(){var b=a.rotation.z;return b=b>a.maxTurnAngle?a.maxTurnAngle:b,b=b<-a.maxTurnAngle?-a.maxTurnAngle:b,a.rotation.z=b,a.vel.x=-a.speed*a.rotation.z/90,a.pos.x-=a.vel.x,a},a}}}(),PlayerController=function(){function a(a){function b(a){!1%a.keyCode&&a.preventDefault();var b={37:d,39:e,65:d,68:e,80:game.togglePlay.bind(game)};b[a.keyCode]&&b[a.keyCode]()}function c(a){a.preventDefault();var b={37:f,39:g,65:f,68:g};b[a.keyCode]&&b[a.keyCode]()}function d(){i=!0}function e(){h=!0}function f(){i=!1}function g(){h=!1}var h=!1,i=!1;return body.on("keydown",b),body.on("keyup",c),{isLeft:i,isRight:h,update:function(){var b=0;i?(b=-a.handling,a.rotation.y>-a.maxLeanAngle*(a.speed/a.maxSpeed)&&(a.rotation.y-=1)):h?(b=a.handling,a.rotation.y<a.maxLeanAngle*(a.speed/a.maxSpeed)&&(a.rotation.y+=1)):(a.rotation.z*=a.smoothness,0!==a.rotation.y&&(a.rotation.y*=.9,a.rotation.y=Math.abs(a.rotation.y)<.1?0:a.rotation.y)),a.rotation.prevZ=a.rotation.z,a.rotation.z+=b}}}var b;return{getInstance:function(c){return b||(b=a(c)),b}}}(),Shadow=function(){return{create:function(a,b,c){var d={};return d.target=b,d.options=c,Positionable(d),Rotatable(d),Scalable(d),Renderable(d),d.update=function(){return d.pos.x=d.target.pos.x-d.options.padding,d.pos.y=d.target.pos.y-d.options.padding,d.rotation.x=d.target.rotation.x,d.rotation.z=d.target.rotation.z,d},d.el=el("div"),d.el.classList.add("shadow"),d.el.classList.add(a),d.el.style.width=toInt(d.target.el.style.width)+2*d.options.padding+"px",d.el.style.height=toInt(d.target.el.style.height)+2*d.options.padding+"px",d.pos.z=2,d}}}(),game=function(){function a(){r=!0,i=Player.create(),j=Shadow.create("car-shadow",i,{padding:3}),k=Level.create(t[0],i),l=PlayerController.getInstance(i),k.destroyCones(),$(".title-view").classList.add("animated","bounceInDown"),k.add(i,"children"),k.add(j,"children"),p.el.appendChild(k.el),c(),body.on("change-view",function(a){f(a.detail)}),body.on("hit-cone",function(a){var b=a.detail.cone,c=1;k.numConesHit++,k.numCombo++,k.numCombo>3&&($(".combo-counter").innerText=k.numCombo,$(".combo-counter-animate").classList.add("show"),k.userCombo<k.numCombo&&(k.userCombo=k.numCombo)),b&&"gold"===b.color&&(c=4,Audio.playNote(k.numConesHit,!0)),Audio.playNote(k.numConesHit),c=k.score+c,k.setScore(c),k.percentComplete()>=100&&k.finished()});for(var a,d=0;d<t.length;d++)a=LevelMenuItem.create(t[d]),$(".levels").appendChild(a);$(".levels").on("click",function(a){if(a.target!==a.currentTarget){var b=a.currentTarget.index(a.target);k.restart(),game.setLevel(b),game.setView("hud-view"),game.start()}}),window.onresize=b,window.player=i,window.playerShadow=j,window.level=k,window.camera=p}function b(){clearTimeout(m),m=setTimeout(function(){c()},300)}function c(){p.render(),i.pos.y=k.height-200,k.offsetZ=.36*-n.clientHeight,k.pos.y=-i.pos.y-.5*i.height,k.render()}function d(){l.update(),i.update().render(),j.update().render(),k.update().render(),p.update().render();for(var a=k.cones.length-1;a>=0;--a)k.cones[a]&&k.cones[a].update().render();q>=1200?q=1200:q+=6,o.style.perspective=q+"px"}function e(){h=requestAnimationFrame(e),d()}function f(a,b){var c=["title-view","instructions-view","level-select-view","pause-view","hud-view","complete-view"],d="pause-view"===a;c.forEach(function(b){a===b||"hud-view"===b&&d||($("."+b).classList.add("exitOutDown"),$("."+b).classList.remove("bounceInDown"))}),delay(function(){c.forEach(function(b){a===b||"hud-view"===b&&d||$("."+b).classList.remove("exitOutDown","animated")})},800),$("."+a).classList.add("animated","bounceInDown"),"pause-view"===a&&(p.set360View(!0),clearInterval(this.pauseInterval),k.pause(),this.pauseInterval=setInterval(function(){p.update().render()},10),game.pause()),"hud-view"===a&&(p.set360View(!1),"pause-view"===this.prevView&&delay(function(){b||k.unpause(),game.start()},1e3)),"complete-view"===a&&(game.levelIndex>=t.length-1?$(".btn-next-level").classList.add("hide"):$(".btn-next-level").classList.remove("hide")),this.prevView=a}function g(a,b,c,d){return function(e){var f=d*(e%b);return a*k.width*.5*Math.sin(f/c*PI*2)+.5*k.width}}var h,i,j,k,l,m,n=$(".game-container"),o=$("#game-canvas"),p=Camera.create("#game-camera"),q=500,r=!1,s=!0,t=[{id:0,name:"Twin Peaks",numCones:4,coneColors:["blue"],bonusConeRatio:.2,scoreToWin:50,speed:18,topColor:"#1D2B64",botColor:"#F8CDDA",patterns:[g(.5,70,10,1)]},{id:1,name:"Stinson",numCones:8,coneColors:["blue"],bonusConeRatio:.1,scoreToWin:70,speed:24,topColor:"#4CB8C4",botColor:"#3CD3AD",patterns:[g(.15,40,70,1)]},{id:2,name:"Big Basin",numCones:6,coneColors:["green"],bonusConeRatio:.3,scoreToWin:100,speed:24,topColor:"#16222A",botColor:"#3A6073",patterns:[g(.3,120,10,1)]},{id:3,name:"Alcatraz",numCones:2,coneColors:["red"],bonusConeRatio:.6,scoreToWin:120,speed:14,topColor:"#1F1C2C",botColor:"#928DAB",patterns:[function(a){var b=200+2*a,c=rand(b,k.width-b);return c}]},{id:4,name:"Ocean Beach",numCones:14,coneColors:["green"],bonusConeRatio:0,scoreToWin:10,speed:24,topColor:"#085078",botColor:"#85D8CE",patterns:[g(.5,70,10,1)]},{id:5,name:"Muir Woods",numCones:8,coneColors:["green"],bonusConeRatio:.5,scoreToWin:40,speed:22,topColor:"#134E5E",botColor:"#71B280",patterns:[g(.6,70,5,1)]},{id:6,name:"San Quentin",numCones:12,coneColors:["red"],bonusConeRatio:.4,scoreToWin:180,speed:24,topColor:"#C04848",botColor:"#480048",patterns:[function(a){return a=rand(0,10*a),a%=k.width-300,a+=150}]},{id:7,name:"The Abyss",numCones:40,coneColors:["red"],bonusConeRatio:.666,scoreToWin:666,speed:46,topColor:"#000",botColor:"#000",patterns:[function(){return rand(50,k.width-50)}]}];return{togglePlay:function(){return s?this.start():this.pause()},start:function(){return r||a(),s&&e(),s=!1,p.el.classList.remove("game-paused"),this},pause:function(){return cancelAnimationFrame(h),_stopTime=time(),p.el.classList.add("game-paused"),s=!0,this},setLevel:function(a){return game.levelIndex=a,p.set360View(!1),k.setOptions(t[a]),this},nextLevel:function(){var a=game.levelIndex+1;return game.setLevel(a).start(),f("hud-view"),k.restart(),this},restartLevel:function(){f("hud-view",!0),k.restart()},exit:function(){f("title-view"),k.destroyCones(),game.start()},setView:function(a){f(a)}}}();